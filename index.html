<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>贝尔LOVE Tour地图</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.17/esri/themes/light/main.css">
 <script src="https://js.arcgis.com/4.17/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      img{
        height: auto;
        width: auto;
        border: 3px solid #cccccc;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>


  </body>
  </body>
</html>
<script>
  require(["esri/Map", "esri/views/MapView",
      "esri/widgets/Locate",
      "esri/widgets/Track",
      "esri/Graphic",
        //*** ADD ***//
        "esri/widgets/Compass",

      "esri/layers/FeatureLayer",



    ]
  , function (Map, MapView, Locate, Track, Graphic, Compass,FeatureLayer) {
    var map = new Map({
  //*** UPDATE ***//
  basemap: "streets-navigation-vector"
});



var trailheadsLabels = {
  symbol: {
    type: "text",
    color: "#FFFFFF",
    haloColor: "#993300",
    haloSize: "5px",
    font: {
      size: "12px",
      family: "Noto Sans",
      style: "italic",
      weight: "normal"
    }
  },
  labelPlacement: "above-center",
  labelExpressionInfo: {
    expression: "$feature.代表才"
  }
};



// Trailheads feature layer (points)
var trailheadsLayer = new FeatureLayer({
  url:
    "https://services7.arcgis.com/yPEKIfOIfL8lOMh6/arcgis/rest/services/beier/FeatureServer",
     labelingInfo: [trailheadsLabels]
});

map.add(trailheadsLayer,0);


var popupTrailheads = {
  title: "{title}",
  content:
    "<b><br><img src='{image}'/><br><b>时间:</b> {time}<br><b>爱的经度:</b> {longitude}<br><b>爱的纬度:</b> {latitude}<br><b>在一起的地方:</b> {address}<br><b>照片故事:</b> {introduction} "
};


var trailheads = new FeatureLayer({
  url:
    "https://services7.arcgis.com/yPEKIfOIfL8lOMh6/arcgis/rest/services/beier/FeatureServer",
  outFields: ["*"],
  popupTemplate: popupTrailheads
});

map.add(trailheads,0);



var view = new MapView({
  container: "viewDiv",
  map: map,
  //*** UPDATE ***//
  center: [126.6430, 45.77509],
  zoom: 12
});

var search = new Search({
  view: view
});



view.ui.add(search, "top-right");

view.on("click", function (evt) {
  search.clear();
  view.popup.clear();
  if (search.activeSource) {
    var geocoder = search.activeSource.locator; // World geocode service
    var params = {
      location: evt.mapPoint
    };
    geocoder.locationToAddress(params).then(
      function (response) {
        // Show the address found
        var address = response.address;
        showPopup(address, evt.mapPoint);
      },
      function (err) {
        // Show no address found
        showPopup("No address found.", evt.mapPoint);
      }
    );
  }
});

function showPopup(address, pt) {
  view.popup.open({
    title:
      +Math.round(pt.longitude * 100000) / 100000 +
      "," +
      Math.round(pt.latitude * 100000) / 100000,
    content: address,
    location: pt
  });
}

var locate = new Locate({
  view: view,
  useHeadingEnabled: false,
  goToOverride: function (view, options) {
    options.target.scale = 1500; // Override the default map scale
    return view.goTo(options.target);
  }
});

view.ui.add(locate, "top-left");

var coordsWidget = document.createElement("div");
coordsWidget.id = "coordsWidget";
coordsWidget.className = "esri-widget esri-component";
coordsWidget.style.padding = "7px 15px 5px";

view.ui.add(coordsWidget, "bottom-right");

//*** ADD ***//
function showCoordinates(pt) {
  var coords =
    "Lat/Lon " +
    pt.latitude.toFixed(3) +
    " " +
    pt.longitude.toFixed(3) +
    " | Scale 1:" +
    Math.round(view.scale * 1) / 1 +
    " | Zoom " +
    view.zoom;
  coordsWidget.innerHTML = coords;
}

view.watch("stationary", function (isStationary) {
  showCoordinates(view.center);
});

//*** ADD ***//
var track = new Track({
  view: view,
  graphic: new Graphic({
    symbol: {
      type: "simple-marker",
      size: "12px",
      color: "green",
      outline: {
        color: "#efefef",
        width: "1.5px"
      }
    }
  }),
  useHeadingEnabled: false // Don't change orientation of the map
});

view.ui.add(track, "top-left");

//*** ADD ***//
var compass = new Compass({
  view: view
});

// adds the compass to the top left corner of the MapView
view.ui.add(compass, "top-left");

locate.on("locate", function(locateEvent){
  addFeature(view.center);
   showCoordinates(view.center);
});

  function addFeature(geometry){
  const attributes= {};
  attributes["utime"]=Date.now();

  const addFeature=new Graphic({
    geometry:geometry,
    attributes:attributes
  });
  trailheadsLayer.applyEdits({
    addFeatures:[addFeature]
  });
}



  });
</script>
